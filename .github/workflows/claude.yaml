name: AI Test Coverage Enhancement

on:
  workflow_dispatch:  # Trigger manual
  schedule:
    - cron: '0 0 * * 1'  # Setiap hari Senin
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.py'  # Hanya dipicu untuk perubahan file Python

jobs:
  enhance-test-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Checkout semua history untuk branch yang tepat
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install anthropic pytest pytest-cov
          # Install dependensi proyek
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Install package dalam mode development
          pip install -e .
      
      - name: Run initial coverage analysis
        run: |
          python -m pytest --cov=./ --cov-report=xml
          
      - name: Generate test improvement with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Install script test generator
          pip install requests dataclasses threading queue deque
          
          # Download script test generator (jika disimpan di repo terpisah)
          # curl -O https://raw.githubusercontent.com/yourusername/claude-test-generator/main/test_generator.py
          
          # Jalankan script test generator
          python -m test_generator --coverage-path coverage.xml --min-coverage 70.0
      
      - name: Run updated tests and measure improvement
        run: |
          python -m pytest
          python -m pytest --cov=./ --cov-report=term
      
      - name: Create PR with test improvements
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Add AI generated tests to improve coverage"
          title: "Improve Test Coverage with AI Generated Tests"
          body: |
            This PR adds tests generated by Claude AI to improve code coverage.
            
            The tests were automatically generated based on code analysis and 
            focus on increasing coverage for functions with low or no test coverage.
            
            Please review the tests and make any necessary adjustments.
          branch: ai-test-improvements-${{ github.run_id }}
          base: ${{ github.head_ref || github.ref_name }}